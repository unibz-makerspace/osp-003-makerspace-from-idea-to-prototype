#include <SimpleTimer.h>

#include <notes.h>
#include <rtttl.h>

SimpleTimer timer;

RamPlayer player(13); // Speaker on pin 13.

//const char *song = "The Simpsons:d=4,o=5,b=160:c.6,e6,f#6,8a6,g.6,e6,c6,8a,8f#,8f#,8f#,2g,8p,8p,8f#,8f#,8f#,8g,a#.,8c6,8c6,8c6,c6";
//const char *song = "Indiana:d=4,o=5,b=250:e,8p,8f,8g,8p,1c6,8p.,d,8p,8e,1f,p.,g,8p,8a,8b,8p,1f6,p,a,8p,8b,2c6,2d6,2e6,e,8p,8f,8g,8p,1c6,p,d6,8p,8e6,1f.6,g,8p,8g,e.6,8p,d6,8p,8g,e.6,8p,d6,8p,8g,f.6,8p,e6,8p,8d6,2c6";
//const char *song = "Bond:d=4,o=5,b=80:32p,16c#6,32d#6,32d#6,16d#6,8d#6,16c#6,16c#6,16c#6,16c#6,32e6,32e6,16e6,8e6,16d#6,16d#6,16d#6,16c#6,32d#6,32d#6,16d#6,8d#6,16c#6,16c#6,16c#6,16c#6,32e6,32e6,16e6,8e6,16d#6,16d6,16c#6,16c#7,c.7,16g#6,16f#6,g#.6";
//const char *song = "StarWars:d=4,o=5,b=45:32p,32f#,32f#,32f#,8b.,8f#.6,32e6,32d#6,32c#6,8b.6,16f#.6,32e6,32d#6,32c#6,8b.6,16f#.6,32e6,32d#6,32e6,8c#.6,32f#,32f#,32f#,8b.,8f#.6,32e6,32d#6,32c#6,8b.6,16f#.6,32e6,32d#6,32c#6,8b.6,16f#.6,32e6,32d#6,32e6,8c#6";
//const char *song = "GoodBad:d=4,o=5,b=56:32p,32a#,32d#6,32a#,32d#6,8a#.,16f#.,16g#.,d#,32a#,32d#6,32a#,32d#6,8a#.,16f#.,16g#.,c#6,32a#,32d#6,32a#,32d#6,8a#.,16f#.,32f.,32d#.,c#,32a#,32d#6,32a#,32d#6,8a#.,16g#.,d#";
//const char *song = "TopGun:d=4,o=4,b=31:32p,16c#,16g#,16g#,32f#,32f,32f#,32f,16d#,16d#,32c#,32d#,16f,32d#,32f,16f#,32f,32c#,16f,d#,16c#,16g#,16g#,32f#,32f,32f#,32f,16d#,16d#,32c#,32d#,16f,32d#,32f,16f#,32f,32c#,g#";
//const char *song = "A-Team:d=8,o=5,b=125:4d#6,a#,2d#6,16p,g#,4a#,4d#.,p,16g,16a#,d#6,a#,f6,2d#6,16p,c#.6,16c6,16a#,g#.,2a#";
//const char *song = "MissionImp:d=16,o=6,b=95:32d,32d#,32d,32d#,32d,32d#,32d,32d#,32d,32d,32d#,32e,32f,32f#,32g,g,8p,g,8p,a#,p,c7,p,g,8p,g,8p,f,p,f#,p,g,8p,g,8p,a#,p,c7,p,g,8p,g,8p,f,p,f#,p,a#,g,2d,32p,a#,g,2c#,32p,a#,g,2c,a#5,8c,2p,32p,a#5,g5,2f#,32p,a#5,g5,2f,32p,a#5,g5,2e,d#,8d";
//const char *song = "20thCenFox:d=16,o=5,b=140:b,8p,b,b,2b,p,c6,32p,b,32p,c6,32p,b,32p,c6,32p,b,8p,b,b,b,32p,b,32p,b,32p,b,32p,b,32p,b,32p,b,32p,g#,32p,a,32p,b,8p,b,b,2b,4p,8e,8g#,8b,1c#6,8f#,8a,8c#6,1e6,8a,8c#6,8e6,1e6,8b,8g#,8a,2b";
//const char *song = "AxelF:d=4,o=5,b=125:32p,8g,8p,16a#.,8p,16g,16p,16g,8c6,8g,8f,8g,8p,16d.6,8p,16g,16p,16g,8d#6,8d6,8a#,8g,8d6,8g6,16g,16f,16p,16f,8d,8a#,2g,p,SS,16f6,8d6,8c6,8a#,g,8a#.,16g,16p,16g,8c6,8g,8f,g,8d.6,16g,16p,16g,8d#6,8d6,8a#,8g,8d6,8g6,16g,16f,16p,16f,8d,8a#,2g";
const char *song = "tetris:d=4,o=5,b=160:e6,8b,8c6,8d6,16e6,16d6,8c6,8b,a,8a,8c6,e6,8d6,8c6,b,8b,8c6,d6,e6,c6,a,2a,8p,d6,8f6,a6,8g6,8f6,e6,8e6,8c6,e6,8d6,8c6,b,8b,8c6,d6,e6,c6,a,a";

void setup() {
  // put your setup code here, to run once:
  unsigned long timePeriodMillis = getTimePeriodMillisFromFrequency(2000/*mHz*/);
  timer.setInterval(timePeriodMillis, onIntervalLedA);
  timer.setInterval(timePeriodMillis, onIntervalLedB);
  timer.setInterval(timePeriodMillis, onIntervalLedC);
  player.setSong(song);
}

void loop() {
  // put your main code here, to run repeatedly:
  player.pollSong();
  timer.run();
}

void onIntervalLedA() {
  static byte analogWriteValue = 127; // Pi/2
  static char stepDirection = +1;     // UP
  doTriangleWaveformOnPin(6, &analogWriteValue, &stepDirection);
}

void onIntervalLedB() {
  static byte analogWriteValue = 191; // Pi3/4
  static char stepDirection = +1;     // UP
  doTriangleWaveformOnPin(9, &analogWriteValue, &stepDirection);
}

void onIntervalLedC() {
  static byte analogWriteValue = 63;  // Pi/4
  static char stepDirection = +1;     // UP
  doTriangleWaveformOnPin(10, &analogWriteValue, &stepDirection);
}

void doTriangleWaveformOnPin(int pin /*[0..13]*/,
    byte /*IN_OUT*/ *analogWriteValue /*[0..255]*/,
    char /*IN_OUT*/ *stepDirection /*+1=UP,-1=DOWN*/) {

  if(*analogWriteValue == 0) {
    // Got to lower limit, reversedirection upwards.
    *stepDirection = +1;
  }
      
  if(*analogWriteValue == 255) {
    // Got to upper limit, reverse direction downwards.
    *stepDirection = -1;
  }

  *analogWriteValue = *analogWriteValue + *stepDirection;
  analogWrite(pin, *analogWriteValue);
}

unsigned long getTimePeriodMillisFromFrequency(
    unsigned long frequency /*[1..2000]mHz*/) {
  return 1000000UL / (2 * 256 * frequency) + 1; // ms
}
